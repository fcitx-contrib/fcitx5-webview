<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        background: rgba(0, 0, 0, 0); /* transparent, draw panel as you wish */
        margin: 0; /* default is 8px */
        overflow: hidden; /* no scrollbar */
        width: 1920px; /* big enough, disregard window size */
        height: 1080px;
        user-select: none; /* disable text select */
      }
      .panel {
        overflow: hidden; /* needed because of border-radius */
        display: inline-block; /* wrap content, not fill parent */
      }
      .preedit, .aux-up, .aux-down {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .preedit.hidden, .aux-up.hidden, .aux-down.hidden {
        display: none; /* needed because the above display has higher precedence than .hidden's */
      }
      .candidates {
        display: flex;
      }
      .candidates.vertical {
        flex-direction: column;
      }
      .candidates.horizontal {
        flex-direction: row;
      }
      .candidate {
        display: flex;
        gap: 6px;
        align-items: center; /* English words have lower height */
        line-height: 1em; /* align label and candidates */
      }
      .hidden {
        display: none;
      }
    </style>
    <style id="macos">
      /* use Digital Color Meter with sRGB mode to get correct color */
      .macos.panel {
        border: 1px solid #5c5c5c;
        border-radius: 6px;
        background-color: #333333;
        font-family: sans-serif;
      }
      .macos .candidate, .macos .preedit, .macos .aux-up, .macos .aux-down {
        color: white;
        min-height: 24px; /* compromise to üÄÑ's height */
        min-width: 16px;
        padding: 3px 7px 3px 7px; /* combine min-height, min-width and padding to make aux-up a square for Â∞è and A */
      }
      .macos .candidate.highlighted {
        background-color: #0059d0;
      }
      .macos .candidates.vertical .candidate:not(:first-child) {
        border-top: 1px solid #5c5c5c;
      }
    </style>
  </head>
  <body>
    <div class="panel macos">
      <div class="header">
        <div class="aux-up hidden"></div>
        <div class="preedit hidden"></div>
      </div>
      <div class="aux-down hidden"></div>
      <div class="candidates">
      </div>
    </div>
    <script>
      const panel = document.querySelector(".panel")
      const candidates = panel.querySelector(".candidates")
      const preedit = document.querySelector(".preedit")
      const auxUp = document.querySelector(".aux-up")
      const auxDown = document.querySelector(".aux-down")

      let cursorX = 0
      let cursorY = 0
      let pressed = false
      let dragging = false
      let startX = 0
      let startY = 0

      document.addEventListener('mousedown', e => {
        pressed = true
        startX = e.clientX
        startY = e.clientY
      })

      document.addEventListener('mousemove', e => {
        if (!pressed) {
          return
        }
        dragging = true
        // minus because macOS has bottom-left (0, 0)
        resize(cursorX + (e.clientX - startX), cursorY - (e.clientY - startY))
      })

      document.addEventListener('mouseup', e => {
        pressed = false
        if (dragging) {
          dragging = false
          return
        }
        let { target } = e
        if (target === candidates || !candidates.contains(target)) {
          return
        }
        while (target.parentElement !== candidates) {
          target = target.parentElement
        }
        for (let i = 0; i < candidates.childElementCount; ++i) {
          if (candidates.children[i] === target) {
            return _select(i)
          }
        }
      })

      function setLayout(layout) {
        switch (layout) {
        case 0:
          candidates.classList.remove("vertical")
          candidates.classList.add("horizontal")
          break
        case 1:
          candidates.classList.remove("horizontal")
          candidates.classList.add("vertical")
        }
      }

      function setCandidates(cands, labels, highlighted) {
        candidates.innerHTML = ""
        for (let i = 0; i < cands.length; ++i) {
          const candidate = document.createElement("div")
          candidate.classList.add("candidate")
          if (i === highlighted) {
            candidate.classList.add("highlighted")
          }
          const label = document.createElement("div")
          label.classList.add("label")
          label.innerHTML = labels[i]
          const text = document.createElement("div")
          text.classList.add("text")
          text.innerHTML = cands[i]
          candidate.appendChild(label)
          candidate.appendChild(text)
          candidates.appendChild(candidate)
        }
      }

      function resize(x, y) {
        cursorX = x
        cursorY = y
        const rect = panel.getBoundingClientRect()
        _resize(x, y, rect.width, rect.height)
      }

      function updateElement(element, innerHTML) {
        if (innerHTML === "") {
            element.classList.add("hidden")
        } else {
            element.innerHTML = innerHTML
            element.classList.remove("hidden")
        }
      }

      function updateInputPanel(preeditHTML, auxUpHTML, auxDownHTML) {
        updateElement(preedit, preeditHTML)
        updateElement(auxUp, auxUpHTML)
        updateElement(auxDown, auxDownHTML)
      }
    </script>
  </body>
</html>
